# SNSオートメーションシステム 開発ロードマップ

## 概要

本ドキュメントは、SNSオートメーションシステムの開発を4つのフェーズに分け、各フェーズのタスク、成果物、完了条件を詳細に定義する。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           開発フェーズ全体像                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Phase 1          Phase 2          Phase 3          Phase 4                │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐            │
│  │   MVP    │───▶│ Platform │───▶│Automation│───▶│   SaaS   │            │
│  │  Core    │    │Integration│    │& Analytics│   │  Launch  │            │
│  │  Engine  │    │          │    │          │    │          │            │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘            │
│                                                                             │
│  ローカルで      Webアプリ化     完全自動運用      マルチテナント            │
│  動画1本生成     ブラウザ操作     Instagram連携    課金・スケール            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Phase 1: MVP (Core Engine)

### 目標
**ローカル環境で1本の高品質な動画が自動生成されること**

### 1.1 開発環境構築

#### 1.1.1 Python環境セットアップ
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Python環境構築 | Python 3.11+ のインストール、venv作成 | `python --version` で確認 |
| 依存パッケージ | requirements.txt作成・インストール | `pip install -r requirements.txt` 成功 |
| FFmpegインストール | システムへのFFmpegインストール | `ffmpeg -version` で確認 |
| フォント設定 | Noto Sans JP のインストール | フォントファイル配置完了 |

**requirements.txt（想定）:**
```
google-generativeai>=0.3.0
openai>=1.0.0
pillow>=10.0.0
elevenlabs>=0.2.0
python-dotenv>=1.0.0
requests>=2.31.0
pydantic>=2.0.0
```

#### 1.1.2 APIキー取得・設定
| サービス | 取得先 | 設定ファイル |
|:---|:---|:---|
| Google AI (Gemini) | Google AI Studio | `.env` |
| OpenAI (DALL-E 3) | OpenAI Platform | `.env` |
| ElevenLabs | ElevenLabs Dashboard | `.env` |

**`.env` テンプレート:**
```bash
GOOGLE_AI_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here
ELEVENLABS_API_KEY=your_key_here
```

### 1.2 台本生成モジュール

#### 1.2.1 Gemini API連携
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| API接続実装 | google-generativeai ライブラリ設定 | 接続テスト成功 |
| プロンプト設計 | 台本生成用プロンプトテンプレート作成 | 期待通りの出力 |
| Grounding設定 | Google検索連携の有効化 | 検索結果が反映された出力 |
| JSON出力制御 | 構造化された台本JSONの出力 | スキーマバリデーション通過 |

**実装ファイル:**
```
src/
├── core/
│   ├── __init__.py
│   ├── script_generator.py      # 台本生成
│   ├── prompts/
│   │   ├── planning.txt         # 企画用プロンプト
│   │   └── script.txt           # 台本用プロンプト
│   └── schemas/
│       └── video_script.py      # Pydanticスキーマ
```

#### 1.2.2 台本JSONスキーマ実装
```python
# video_script.py
from pydantic import BaseModel, Field
from typing import List, Optional
from enum import Enum

class AnimationType(str, Enum):
    ZOOM_IN = "zoom_in"
    ZOOM_OUT = "zoom_out"
    PAN = "pan"
    NONE = "none"

class TextElement(BaseModel):
    content: str
    x: int = Field(ge=0, le=100)
    y: int = Field(ge=0, le=100)
    font_size: int = Field(ge=24, le=120)
    color: str = "#FFFFFF"

class Slide(BaseModel):
    order: int
    duration: float = Field(ge=3, le=15)
    background_prompt: str
    text_elements: List[TextElement]
    narration: str
    animation: AnimationType = AnimationType.ZOOM_IN

class VideoScript(BaseModel):
    title: str = Field(max_length=30)
    hook: str = Field(max_length=15)
    slides: List[Slide] = Field(min_length=4, max_length=8)
    total_duration: float = Field(le=60)
    caption: str
    hashtags: List[str] = Field(max_length=30)
```

### 1.3 画像生成モジュール

#### 1.3.1 DALL-E 3連携
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| API接続実装 | OpenAI Python SDK設定 | 画像生成テスト成功 |
| プロンプト最適化 | 縦長・文字なし・余白ありのプロンプト | 要件を満たす画像出力 |
| エラーハンドリング | リトライ・フォールバック実装 | 安定した生成 |
| 画像保存 | ローカルへの保存処理 | ファイル出力確認 |

**実装ファイル:**
```
src/
├── generation/
│   ├── __init__.py
│   ├── image_generator.py       # DALL-E連携
│   └── prompt_templates.py      # 画像用プロンプト
```

#### 1.3.2 プロンプトテンプレート
```python
BACKGROUND_PROMPT_TEMPLATE = """
Create a {style} background image for a business educational video.

Theme: {theme}
Color scheme: {color_scheme}

STRICT Requirements:
- Absolutely NO text, letters, numbers, or characters in the image
- Leave generous clear space in the center for text overlay
- Aspect ratio: 9:16 (vertical/portrait orientation)
- Style: Modern, clean, professional
- Do NOT include any human faces or identifiable people
- Abstract or symbolic representations preferred
"""
```

### 1.4 テキスト合成モジュール

#### 1.4.1 Pillow実装
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| 基本合成 | 画像へのテキスト描画 | テキスト表示確認 |
| フォント設定 | 日本語フォント読み込み・サイズ設定 | 文字化けなし |
| 装飾実装 | 縁取り・影・背景ボックス | 視認性確保 |
| 位置計算 | 中央揃え・座標計算 | 正確な配置 |

**実装ファイル:**
```
src/
├── composition/
│   ├── __init__.py
│   ├── text_renderer.py         # テキスト描画
│   ├── font_manager.py          # フォント管理
│   └── slide_composer.py        # スライド合成
```

#### 1.4.2 テキストレンダリング仕様
```python
class TextRenderer:
    def __init__(self, font_path: str):
        self.fonts = {
            "title": ImageFont.truetype(font_path, 72),
            "body": ImageFont.truetype(font_path, 48),
            "emphasis": ImageFont.truetype(font_path, 64),
        }

    def render_text(
        self,
        image: Image,
        text: str,
        position: tuple,
        style: str = "body",
        stroke_width: int = 2,
        stroke_color: str = "#000000"
    ) -> Image:
        # テキスト描画ロジック
        pass
```

### 1.5 音声生成モジュール

#### 1.5.1 ElevenLabs連携
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| API接続実装 | ElevenLabs SDK設定 | 音声生成テスト成功 |
| 日本語音声設定 | 適切なVoice ID選定 | 自然な日本語音声 |
| 音声パラメータ調整 | スピード・安定性の最適化 | 聞き取りやすい音声 |
| ファイル保存 | MP3/WAV形式での保存 | ファイル出力確認 |

**実装ファイル:**
```
src/
├── audio/
│   ├── __init__.py
│   ├── tts_generator.py         # 音声生成
│   └── audio_processor.py       # 音声処理
```

### 1.6 動画合成モジュール

#### 1.6.1 FFmpeg実装
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| スライド結合 | 複数画像の動画化 | シーケンス再生確認 |
| 音声同期 | ナレーション・BGM合成 | 音ズレなし |
| エフェクト追加 | Ken Burnsエフェクト実装 | ズーム効果確認 |
| トランジション | クロスフェード実装 | 滑らかな遷移 |
| 出力最適化 | Instagram仕様準拠のエンコード | アップロード可能 |

**実装ファイル:**
```
src/
├── video/
│   ├── __init__.py
│   ├── ffmpeg_composer.py       # FFmpeg制御
│   ├── effects.py               # エフェクト定義
│   └── encoder.py               # エンコード設定
```

#### 1.6.2 FFmpegコマンド例
```python
def compose_video(slides: List[str], audio: str, output: str):
    # スライド結合（各スライド5秒、ズームエフェクト付き）
    filter_complex = []
    for i, slide in enumerate(slides):
        filter_complex.append(
            f"[{i}:v]scale=1080:1920,zoompan=z='min(zoom+0.001,1.1)'"
            f":d={5*30}:x='iw/2-(iw/zoom/2)':y='ih/2-(ih/zoom/2)'[v{i}]"
        )

    # クロスフェードで結合
    # 音声ミックス
    # H.264エンコード
```

### 1.7 統合・テスト

#### 1.7.1 パイプライン統合
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| メインスクリプト作成 | 全モジュールの統合 | E2E実行成功 |
| 設定ファイル整備 | config.yaml作成 | パラメータ外部化 |
| エラーハンドリング | 各段階での例外処理 | 適切なエラーメッセージ |
| ログ出力 | 処理状況の可視化 | デバッグ可能 |

**ディレクトリ構造（最終）:**
```
sns-automation/
├── src/
│   ├── core/
│   │   ├── script_generator.py
│   │   └── schemas/
│   ├── generation/
│   │   └── image_generator.py
│   ├── composition/
│   │   ├── text_renderer.py
│   │   └── slide_composer.py
│   ├── audio/
│   │   └── tts_generator.py
│   ├── video/
│   │   └── ffmpeg_composer.py
│   └── main.py                  # エントリーポイント
├── config/
│   └── config.yaml
├── assets/
│   ├── fonts/
│   └── bgm/
├── output/
├── tests/
├── requirements.txt
├── .env
└── README.md
```

#### 1.7.2 品質検証
| チェック項目 | 基準 | 確認方法 |
|:---|:---|:---|
| 動画解像度 | 1080x1920 | メディア情報確認 |
| 動画長 | 60秒以内 | 再生時間確認 |
| テキスト視認性 | スマホで読める | 実機確認 |
| 音声品質 | クリアで聞き取りやすい | 再生確認 |
| ファイルサイズ | 100MB以下 | ファイルサイズ確認 |

### Phase 1 完了条件
- [ ] コマンド一発で動画が生成される
- [ ] 生成された動画がInstagramリール仕様を満たす
- [ ] 生成時間が5分以内
- [ ] エラー発生時に適切なメッセージが表示される

---

## Phase 2: Platform Integration

### 目標
**ブラウザから操作できるWebアプリケーション化**

### 2.1 Next.js プロジェクト構築

#### 2.1.1 プロジェクト初期化
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Next.js作成 | App Router使用、TypeScript | プロジェクト作成完了 |
| UIライブラリ | shadcn/ui + Tailwind CSS導入 | コンポーネント使用可能 |
| ESLint/Prettier | コード品質設定 | リント通過 |
| 環境変数設定 | .env.local作成 | 設定読み込み確認 |

```bash
# プロジェクト作成コマンド
npx create-next-app@latest sns-automation-web --typescript --tailwind --eslint --app --src-dir
```

#### 2.1.2 ディレクトリ構造
```
sns-automation-web/
├── src/
│   ├── app/
│   │   ├── (auth)/
│   │   │   ├── login/page.tsx
│   │   │   └── signup/page.tsx
│   │   ├── (dashboard)/
│   │   │   ├── layout.tsx
│   │   │   ├── page.tsx              # ダッシュボード
│   │   │   ├── calendar/page.tsx     # カレンダー
│   │   │   ├── posts/
│   │   │   │   ├── page.tsx          # 投稿一覧
│   │   │   │   └── [id]/page.tsx     # 投稿詳細
│   │   │   ├── analytics/page.tsx    # 分析
│   │   │   └── settings/page.tsx     # 設定
│   │   ├── api/
│   │   │   ├── posts/route.ts
│   │   │   ├── generate/route.ts
│   │   │   └── planning/route.ts
│   │   ├── layout.tsx
│   │   └── page.tsx                  # LP
│   ├── components/
│   │   ├── ui/                       # shadcn components
│   │   ├── calendar/
│   │   ├── posts/
│   │   └── layout/
│   ├── lib/
│   │   ├── supabase/
│   │   │   ├── client.ts
│   │   │   ├── server.ts
│   │   │   └── middleware.ts
│   │   ├── api/
│   │   └── utils/
│   ├── hooks/
│   ├── stores/                       # Zustand stores
│   └── types/
├── public/
├── .env.local
└── package.json
```

### 2.2 Supabase連携

#### 2.2.1 プロジェクト作成・設定
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| プロジェクト作成 | Supabaseダッシュボードで作成 | 接続情報取得 |
| テーブル作成 | SQL実行でスキーマ構築 | 全テーブル作成完了 |
| RLS設定 | 行レベルセキュリティポリシー設定 | セキュリティテスト通過 |
| Storage設定 | バケット作成・権限設定 | アップロードテスト成功 |

#### 2.2.2 データベーススキーマ
```sql
-- 1. profiles テーブル
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  ig_user_id TEXT,
  ig_access_token TEXT,
  ig_token_expires_at TIMESTAMPTZ,
  preferences JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. posts テーブル
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  hook TEXT,
  category TEXT,
  script_json JSONB,
  caption TEXT,
  hashtags TEXT[],
  status TEXT NOT NULL DEFAULT 'planned',
  scheduled_at TIMESTAMPTZ,
  published_at TIMESTAMPTZ,
  ig_media_id TEXT,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. assets テーブル
CREATE TABLE assets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  url TEXT NOT NULL,
  storage_path TEXT NOT NULL,
  metadata JSONB DEFAULT '{}'::jsonb,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. analytics テーブル
CREATE TABLE analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  impressions INTEGER DEFAULT 0,
  reach INTEGER DEFAULT 0,
  plays INTEGER DEFAULT 0,
  likes INTEGER DEFAULT 0,
  comments INTEGER DEFAULT 0,
  saves INTEGER DEFAULT 0,
  shares INTEGER DEFAULT 0,
  engagement_rate DECIMAL(5,4),
  collected_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_posts_user_status ON posts(user_id, status);
CREATE INDEX idx_posts_scheduled ON posts(scheduled_at);

-- RLSポリシー
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE posts ENABLE ROW LEVEL SECURITY;
ALTER TABLE assets ENABLE ROW LEVEL SECURITY;
ALTER TABLE analytics ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own data" ON profiles FOR ALL USING (auth.uid() = id);
CREATE POLICY "Users can manage own posts" ON posts FOR ALL USING (auth.uid() = user_id);
CREATE POLICY "Users can view own assets" ON assets FOR ALL
  USING (post_id IN (SELECT id FROM posts WHERE user_id = auth.uid()));
CREATE POLICY "Users can view own analytics" ON analytics FOR ALL
  USING (post_id IN (SELECT id FROM posts WHERE user_id = auth.uid()));
```

#### 2.2.3 認証実装
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Supabase Auth設定 | メール認証有効化 | 設定完了 |
| ログインUI | ログイン/サインアップページ | UI表示確認 |
| セッション管理 | ミドルウェアでの認証チェック | 保護ページアクセス制御 |
| プロフィール連携 | ユーザー作成時にprofiles作成 | トリガー動作確認 |

### 2.3 カレンダーUI実装

#### 2.3.1 コンポーネント開発
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| カレンダーグリッド | 月間表示のグリッドUI | 表示確認 |
| 投稿カード | ステータス色分け表示 | 視覚的に識別可能 |
| ドラッグ&ドロップ | react-dnd使用 | 日付変更動作 |
| モーダル | 投稿詳細・編集モーダル | CRUD動作確認 |

#### 2.3.2 状態管理（Zustand）
```typescript
// stores/posts.ts
interface PostsStore {
  posts: Post[];
  selectedDate: Date;
  filters: {
    status: PostStatus | null;
    category: string | null;
  };

  // Actions
  fetchPosts: (month: Date) => Promise<void>;
  updatePostDate: (postId: string, newDate: Date) => Promise<void>;
  updatePostStatus: (postId: string, status: PostStatus) => Promise<void>;
  setFilters: (filters: Partial<PostsStore['filters']>) => void;
}
```

### 2.4 Cloud Run移行

#### 2.4.1 Docker化
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Dockerfile作成 | Python + FFmpeg環境 | ローカルビルド成功 |
| 依存関係整理 | 最小構成の特定 | イメージサイズ最適化 |
| エントリーポイント | HTTP/ジョブ両対応 | 起動確認 |

**Dockerfile:**
```dockerfile
FROM python:3.11-slim

# FFmpegインストール
RUN apt-get update && apt-get install -y ffmpeg fonts-noto-cjk && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY src/ ./src/
COPY config/ ./config/
COPY assets/ ./assets/

# Cloud Run Jobs用
CMD ["python", "src/main.py"]
```

#### 2.4.2 Cloud Runデプロイ
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| GCPプロジェクト設定 | プロジェクト作成・API有効化 | コンソールアクセス確認 |
| Artifact Registry | コンテナリポジトリ作成 | プッシュ成功 |
| Cloud Run Jobs | ジョブ作成・設定 | 手動実行成功 |
| シークレット管理 | Secret Managerでキー管理 | 環境変数読み込み確認 |

```bash
# デプロイコマンド
gcloud builds submit --tag asia-northeast1-docker.pkg.dev/PROJECT_ID/sns-automation/video-generator

gcloud run jobs create video-generator \
  --image asia-northeast1-docker.pkg.dev/PROJECT_ID/sns-automation/video-generator \
  --region asia-northeast1 \
  --memory 4Gi \
  --cpu 2 \
  --max-retries 1 \
  --task-timeout 10m
```

### 2.5 API実装

#### 2.5.1 Next.js API Routes
| エンドポイント | メソッド | 機能 |
|:---|:---|:---|
| `/api/posts` | GET | 投稿一覧取得 |
| `/api/posts` | POST | 投稿作成 |
| `/api/posts/[id]` | GET/PATCH/DELETE | 投稿CRUD |
| `/api/posts/[id]/generate` | POST | 動画生成トリガー |
| `/api/planning/generate` | POST | 月次企画生成 |

#### 2.5.2 Cloud Run連携
```typescript
// lib/cloudrun.ts
export async function triggerVideoGeneration(postId: string) {
  const auth = new GoogleAuth();
  const client = await auth.getIdTokenClient(CLOUD_RUN_URL);

  const response = await client.request({
    url: `${CLOUD_RUN_URL}/generate`,
    method: 'POST',
    data: { postId },
  });

  return response.data;
}
```

### 2.6 プレビュー機能

#### 2.6.1 動画プレビューUI
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| 動画プレーヤー | react-player使用 | 再生確認 |
| サムネイル表示 | 生成済み動画のサムネイル | 一覧表示確認 |
| ダウンロード | 動画ファイルダウンロード | DL動作確認 |
| 承認UI | 承認/却下ボタン | ステータス更新確認 |

### Phase 2 完了条件
- [ ] ブラウザからログイン/ログアウトができる
- [ ] カレンダーUIで投稿管理ができる
- [ ] 「生成」ボタンで動画がCloud Runで生成される
- [ ] 生成された動画をプレビュー・ダウンロードできる
- [ ] Vercelへデプロイされている

---

## Phase 3: Automation & Analytics

### 目標
**完全自動運用とInstagram連携**

### 3.1 Meta API連携

#### 3.1.1 Instagram Business Account設定
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Metaアプリ作成 | Meta for Developers | App ID取得 |
| 権限申請 | instagram_content_publish等 | 権限承認 |
| OAuth実装 | アクセストークン取得フロー | トークン取得成功 |
| トークン管理 | 長期トークン・自動更新 | 60日間有効 |

#### 3.1.2 OAuth実装
```typescript
// app/api/auth/instagram/route.ts
export async function GET(request: Request) {
  const url = `https://api.instagram.com/oauth/authorize?
    client_id=${META_APP_ID}
    &redirect_uri=${REDIRECT_URI}
    &scope=instagram_basic,instagram_content_publish,instagram_manage_insights
    &response_type=code`;

  return Response.redirect(url);
}

// app/api/auth/instagram/callback/route.ts
export async function GET(request: Request) {
  const code = request.nextUrl.searchParams.get('code');

  // 短期トークン取得
  const shortToken = await exchangeCodeForToken(code);

  // 長期トークン交換
  const longToken = await exchangeForLongLivedToken(shortToken);

  // DBに保存
  await saveInstagramToken(userId, longToken);

  return Response.redirect('/dashboard/settings');
}
```

### 3.2 自動投稿機能

#### 3.2.1 投稿スケジューラー
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Cron設定 | Vercel Cron Jobs | 定期実行確認 |
| 投稿処理 | Meta APIでリール投稿 | 投稿成功 |
| ステータス更新 | 投稿後のDB更新 | 正確なステータス |
| 失敗処理 | リトライ・通知 | エラーハンドリング |

```typescript
// app/api/cron/publish/route.ts
export async function GET(request: Request) {
  // 認証チェック（Vercel Cron用）
  if (request.headers.get('Authorization') !== `Bearer ${CRON_SECRET}`) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 投稿予定の取得（現在時刻の前後5分）
  const postsToPublish = await getScheduledPosts();

  for (const post of postsToPublish) {
    await publishToInstagram(post);
  }

  return Response.json({ published: postsToPublish.length });
}
```

#### 3.2.2 Meta Graph API投稿
```typescript
async function publishToInstagram(post: Post) {
  const videoUrl = await getSignedUrl(post.videoPath);

  // 1. メディアコンテナ作成
  const container = await fetch(
    `https://graph.facebook.com/v18.0/${IG_USER_ID}/media`,
    {
      method: 'POST',
      body: JSON.stringify({
        media_type: 'REELS',
        video_url: videoUrl,
        caption: post.caption,
        share_to_feed: true,
      }),
    }
  );

  // 2. 処理完了待ち（ポーリング）
  await waitForMediaProcessing(container.id);

  // 3. 公開
  const result = await fetch(
    `https://graph.facebook.com/v18.0/${IG_USER_ID}/media_publish`,
    {
      method: 'POST',
      body: JSON.stringify({ creation_id: container.id }),
    }
  );

  return result;
}
```

### 3.3 アナリティクス機能

#### 3.3.1 データ収集
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| インサイト取得Cron | 24時間/72時間/7日後 | 自動収集確認 |
| データ保存 | analyticsテーブルへ格納 | データ蓄積確認 |
| 計算指標 | エンゲージメント率等の算出 | 正確な計算 |

```typescript
// app/api/cron/analytics/route.ts
export async function GET(request: Request) {
  // 対象投稿の取得（投稿後24時間/72時間/7日）
  const targetPosts = await getPostsForAnalyticsCollection();

  for (const post of targetPosts) {
    const insights = await fetchInstagramInsights(post.ig_media_id);
    await saveAnalytics(post.id, insights);
  }

  return Response.json({ collected: targetPosts.length });
}
```

#### 3.3.2 ダッシュボードUI
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| サマリーカード | 総再生数・いいね等 | 表示確認 |
| トレンドグラフ | 時系列チャート（recharts） | グラフ表示 |
| 投稿別ランキング | エンゲージメント順 | ソート表示 |
| カテゴリ分析 | カテゴリ別パフォーマンス | 比較表示 |

### 3.4 AI編集会議

#### 3.4.1 月次企画自動生成
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Cron設定 | 月初自動実行 | 定期実行確認 |
| 過去データ分析 | analyticsからパターン抽出 | 分析ロジック動作 |
| トレンド取得 | Gemini Grounding検索 | 最新情報反映 |
| 企画生成 | 30日分の企画作成 | DB保存確認 |

```typescript
// lib/planning/ai-meeting.ts
export async function runAIEditorialMeeting(userId: string) {
  // 1. 過去データ分析
  const pastPerformance = await analyzePastPosts(userId);
  const winningPatterns = extractWinningPatterns(pastPerformance);

  // 2. トレンドリサーチ
  const trends = await researchTrends(userPreferences.themes);

  // 3. 企画生成
  const prompt = buildPlanningPrompt(winningPatterns, trends, userPreferences);
  const plans = await generateWithGemini(prompt);

  // 4. スケジュール最適化
  const optimizedPlans = optimizeSchedule(plans, pastPerformance);

  // 5. DB保存
  await savePlannedPosts(userId, optimizedPlans);

  return optimizedPlans;
}
```

### 3.5 通知機能

#### 3.5.1 通知システム
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| メール通知 | Resend使用 | メール受信確認 |
| アプリ内通知 | Supabase Realtime | リアルタイム表示 |
| 通知設定 | ユーザー設定画面 | カスタマイズ可能 |

**通知トリガー:**
- 動画生成完了 → レビュー依頼メール
- 投稿完了 → 投稿完了通知
- 投稿失敗 → エラー通知
- 月次企画完了 → 確認依頼通知

### Phase 3 完了条件
- [ ] Instagramアカウント連携ができる
- [ ] 承認済み動画が予定時刻に自動投稿される
- [ ] 投稿後のアナリティクスが自動収集される
- [ ] ダッシュボードでパフォーマンスが確認できる
- [ ] 月初に30日分の企画が自動生成される
- [ ] 各イベントで通知が届く

---

## Phase 4: SaaS Launch

### 目標
**マルチテナント対応とサブスクリプション課金**

### 4.1 マルチテナント対応

#### 4.1.1 テナント分離
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| RLS強化 | 全クエリでuser_idフィルタ | セキュリティテスト通過 |
| ストレージ分離 | ユーザー別フォルダ構造 | アクセス制御確認 |
| レート制限 | ユーザー別API制限 | 制限動作確認 |

#### 4.1.2 プラン別機能制限
```typescript
// lib/subscription.ts
const PLAN_LIMITS = {
  free: {
    postsPerMonth: 5,
    storageGB: 1,
    features: ['basic_generation'],
  },
  starter: {
    postsPerMonth: 30,
    storageGB: 10,
    features: ['basic_generation', 'auto_publish', 'analytics'],
  },
  pro: {
    postsPerMonth: 100,
    storageGB: 50,
    features: ['basic_generation', 'auto_publish', 'analytics', 'ai_meeting', 'priority_support'],
  },
};
```

### 4.2 課金システム

#### 4.2.1 Stripe連携
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Stripe設定 | 商品・価格設定 | ダッシュボード確認 |
| Checkout実装 | Stripe Checkout Session | 決済フロー動作 |
| Webhook処理 | サブスクリプション更新 | ステータス同期 |
| ポータル | カスタマーポータル連携 | プラン変更可能 |

```typescript
// app/api/stripe/checkout/route.ts
export async function POST(request: Request) {
  const { priceId } = await request.json();

  const session = await stripe.checkout.sessions.create({
    mode: 'subscription',
    payment_method_types: ['card'],
    line_items: [{ price: priceId, quantity: 1 }],
    success_url: `${BASE_URL}/dashboard?success=true`,
    cancel_url: `${BASE_URL}/pricing?canceled=true`,
    customer_email: user.email,
    metadata: { userId: user.id },
  });

  return Response.json({ url: session.url });
}
```

### 4.3 ランディングページ

#### 4.3.1 LP実装
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| ヒーローセクション | キャッチコピー・CTA | 表示確認 |
| 機能紹介 | 主要機能の説明 | コンテンツ確認 |
| 料金表 | プラン比較表 | 表示確認 |
| FAQ | よくある質問 | コンテンツ確認 |
| フッター | 利用規約・プライバシー | リンク動作 |

### 4.4 運用体制

#### 4.4.1 監視・運用
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| エラー監視 | Sentry導入 | エラー通知確認 |
| パフォーマンス監視 | Vercel Analytics | ダッシュボード確認 |
| ログ管理 | 構造化ログ | 検索可能 |
| アラート設定 | Slack通知 | 通知確認 |

#### 4.4.2 サポート体制
| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| ヘルプセンター | FAQ・ガイド作成 | コンテンツ公開 |
| チャットサポート | Intercom等導入 | 応対可能 |
| フィードバック | フィードバックフォーム | 収集可能 |

### Phase 4 完了条件
- [ ] 複数ユーザーが同時利用できる
- [ ] クレジットカード決済でサブスクリプション開始できる
- [ ] プラン別の機能制限が正しく動作する
- [ ] ランディングページが公開されている
- [ ] エラー・パフォーマンス監視が稼働している

---

## マイルストーンサマリー

```
Phase 1 完了
├── ローカルで動画生成可能
└── 品質基準クリア

Phase 2 完了
├── Webアプリとして動作
├── Cloud Runで動画生成
└── カレンダーUI完成

Phase 3 完了
├── Instagram自動投稿
├── アナリティクス自動収集
├── AI企画生成
└── 通知システム稼働

Phase 4 完了
├── マルチテナント対応
├── サブスクリプション課金
├── ランディングページ公開
└── SaaS正式ローンチ
```

---

## 技術的負債の管理

### 各フェーズで意識する品質基準
| 項目 | Phase 1 | Phase 2 | Phase 3 | Phase 4 |
|:---|:---|:---|:---|:---|
| テストカバレッジ | 50% | 70% | 80% | 85% |
| 型安全性 | 基本 | 厳格 | 厳格 | 厳格 |
| ドキュメント | README | API仕様 | 運用手順 | ユーザーガイド |
| セキュリティ | 基本 | RLS | OAuth | ペネトレ |

### リファクタリングポイント
- Phase 1 → 2: モノリシック → モジュール分割
- Phase 2 → 3: 手動トリガー → 自動化
- Phase 3 → 4: シングルテナント → マルチテナント

---

## リスクと対策

| リスク | 影響 | 対策 |
|:---|:---|:---|
| API料金超過 | コスト増 | 使用量アラート、月額上限設定 |
| 生成品質の不安定 | ユーザー離脱 | プロンプト継続改善、人的チェック導入 |
| Instagram API制限 | 機能制限 | レート制限管理、キュー実装 |
| セキュリティ脆弱性 | 信用失墜 | 定期監査、脆弱性スキャン |

---

**文書管理情報**
- 作成日: 2025-12-13
- 作成者: Claude Code
- ステータス: 承認待ち
- 次回レビュー: Phase 1 開始前
