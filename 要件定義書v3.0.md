# SNSオートメーションシステム 要件定義書 (Ver 3.0)

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|:---|:---|:---|
| 1.0 | - | 初版作成 |
| 2.0 | - | SaaS対応構成の追加、アーキテクチャ刷新 |
| 3.0 | 2025-12-13 | 詳細仕様追加、セキュリティ要件、API仕様、エラーハンドリング、テスト戦略の追加 |

---

## 1. プロジェクト概要

### 1.1. プロダクトビジョン
**「1日1分、ビジネスの視座を高める」**

中小企業経営者や個人事業主をターゲットに、単なるノウハウの羅列ではなく、深いリサーチ（Deep Research）に基づいた有益なビジネス情報を、Instagramリール（60秒動画）形式で自動配信する。

### 1.2. 開発目的
1. **自社運用:** 開発者自身のブランド構築における「コンテンツ制作の工数ゼロ化」と「質の担保」の両立。
2. **SaaS展開:** 将来的に同ターゲット層（時間のない経営者など）へ向けた月額課金型ツールとしてリリースする。

### 1.3. コア・バリュー（差別化要因）
| 要素 | 説明 | 競合との差別化 |
|:---|:---|:---|
| **Deep Research** | Google検索と複合推論を用いた「NotebookLM級」の深い情報設計 | 一般的なAI生成の薄い回答ではなく、実用性の高い情報を提供 |
| **High Readability** | プログラム合成による「絶対に崩れない・読める」スライドデザイン | 画像生成AIに文字を書かせないため品質が安定 |
| **AI-Driven PDCA** | 過去データ分析とトレンド反映による「勝てる企画」の自律立案 | 人手不要の継続改善サイクル |

### 1.4. ターゲットユーザー

#### プライマリターゲット
- **属性:** 中小企業経営者、個人事業主、フリーランス
- **課題:** SNS運用の重要性は理解しているが、コンテンツ制作に割く時間がない
- **ニーズ:** 専門性のある高品質コンテンツを手間なく継続発信したい

#### セカンダリターゲット
- **属性:** マーケティング担当者、コンサルタント
- **課題:** クライアントのSNS運用を効率化したい
- **ニーズ:** 複数アカウントの一括管理、レポーティング機能

### 1.5. 成功指標（KPI）

| 指標 | MVP目標 | SaaS化後目標 |
|:---|:---|:---|
| 動画生成成功率 | 95%以上 | 99%以上 |
| 生成時間（1本あたり） | 5分以内 | 3分以内 |
| 平均エンゲージメント率 | 業界平均+20% | 業界平均+50% |
| 月間運用コスト/ユーザー | 2,000円以内 | 1,500円以内 |

---

## 2. システムアーキテクチャ

### 2.1. 全体構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              User Interface                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Next.js (App Router)                          │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐   │   │
│  │  │ Dashboard │  │ Calendar │  │ Analytics│  │ Settings     │   │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                     │
│                                    ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         API Layer                                │   │
│  │  ┌──────────────────┐  ┌──────────────────┐                    │   │
│  │  │ Next.js API Routes│  │ Edge Functions   │                    │   │
│  │  └──────────────────┘  └──────────────────┘                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                            Backend Services                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────────┐ │
│  │   Supabase   │  │ Cloud Run    │  │      External APIs           │ │
│  │  ┌────────┐  │  │   (Jobs)     │  │  ┌─────────┐ ┌────────────┐ │ │
│  │  │  Auth  │  │  │  ┌────────┐  │  │  │ Gemini  │ │  DALL-E 3  │ │ │
│  │  ├────────┤  │  │  │ Video  │  │  │  │  Pro    │ │  (OpenAI)  │ │ │
│  │  │   DB   │  │  │  │Generator│  │  │  └─────────┘ └────────────┘ │ │
│  │  ├────────┤  │  │  └────────┘  │  │  ┌─────────┐ ┌────────────┐ │ │
│  │  │Storage │  │  │  ┌────────┐  │  │  │ElevenLabs│ │ Meta API   │ │ │
│  │  └────────┘  │  │  │ FFmpeg │  │  │  │  (TTS)  │ │ (Instagram)│ │ │
│  │              │  │  │ Pillow │  │  │  └─────────┘ └────────────┘ │ │
│  └──────────────┘  │  └────────┘  │  └──────────────────────────────┘ │
│                    └──────────────┘                                     │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2. 技術スタック詳細

| レイヤー | 技術 | バージョン | 選定理由 |
|:---|:---|:---|:---|
| **Frontend** | Next.js (App Router) | 14.x | SSR/SSG対応、Vercel統合、React Server Components |
| **UIライブラリ** | shadcn/ui + Tailwind CSS | 最新 | カスタマイズ性、アクセシビリティ対応 |
| **状態管理** | Zustand | 4.x | 軽量、TypeScript対応 |
| **Backend/DB** | Supabase | 最新 | PostgreSQL、認証、リアルタイム機能を統合 |
| **Storage** | Supabase Storage | - | S3互換、CDN配信対応 |
| **Worker** | Google Cloud Run Jobs | - | コンテナベース、秒単位課金、長時間処理対応 |
| **AI (LLM)** | Gemini 1.5 Pro | 最新 | 長文コンテキスト、Grounding機能 |
| **AI (画像)** | DALL-E 3 | 最新 | プロンプト追従性、高品質出力 |
| **TTS** | ElevenLabs | API v1 | 日本語対応、自然な音声 |
| **動画処理** | FFmpeg + Pillow | 6.x / 10.x | 業界標準、柔軟な処理 |

### 2.3. インフラ構成

#### 2.3.1. 本番環境
```
Frontend: Vercel (Pro Plan)
  - リージョン: 東京 (hnd1)
  - Edge Functions: グローバル

Backend: Supabase (Pro Plan)
  - リージョン: 東京
  - PostgreSQL: 2 vCPU, 4GB RAM

Worker: Google Cloud Run
  - リージョン: asia-northeast1 (東京)
  - vCPU: 2
  - メモリ: 4GB
  - タイムアウト: 10分
```

#### 2.3.2. 開発環境
```
Frontend: Vercel (Hobby/Preview)
Backend: Supabase (Free Tier)
Worker: ローカルDocker または Cloud Run (dev)
```

### 2.4. 通信プロトコル

| 通信経路 | プロトコル | 認証方式 |
|:---|:---|:---|
| Client ↔ Next.js | HTTPS | Supabase Auth (JWT) |
| Next.js ↔ Supabase | HTTPS | Service Role Key |
| Next.js ↔ Cloud Run | HTTPS | Service Account + IAM |
| Cloud Run ↔ External APIs | HTTPS | API Key (各サービス) |

---

## 3. 機能要件詳細

### 3.1. 企画・管理フェーズ (The "Brain")

#### 3.1.1. AI編集会議（月次バッチ処理）

**機能概要:**
月初に30日分のコンテンツ企画をAIが自動生成する。過去の成功パターンとトレンドを分析し、エンゲージメント最大化を目指す。

**トリガー条件:**
- 月初（1日 00:00 JST）の自動実行
- ユーザーによる「一括生成」ボタン押下
- 残り企画数が5件を下回った場合の自動補充

**入力データ:**
```typescript
interface PlanningInput {
  // 過去データ
  pastPosts: {
    title: string;
    category: string;
    engagementRate: number;
    views: number;
    saves: number;
    postedAt: Date;
  }[];

  // ユーザー設定
  userPreferences: {
    targetAudience: string;          // 例: "中小企業経営者"
    mainThemes: string[];            // 例: ["マーケティング", "財務管理"]
    monthlyFocusTheme?: string;      // 今月の強化テーマ
    excludeTopics: string[];         // 除外トピック
    toneOfVoice: "formal" | "casual" | "friendly";
  };

  // 生成設定
  generationConfig: {
    totalPosts: number;              // 生成数（デフォルト: 30）
    winningPatternRatio: number;     // 勝ちパターン比率（デフォルト: 0.7）
    trendRatio: number;              // トレンド比率（デフォルト: 0.3）
  };
}
```

**処理フロー:**
```
1. 過去データ分析
   ├── エンゲージメント上位20%のパターン抽出
   ├── カテゴリ別パフォーマンス分析
   └── 投稿時間帯別効果分析

2. トレンドリサーチ (Gemini Grounding)
   ├── "ビジネス トレンド 2024" 検索
   ├── "法改正 中小企業 最新" 検索
   ├── 業界特化キーワード検索
   └── 検索結果の要約・構造化

3. 企画生成
   ├── 勝ちパターンベース企画（70%）
   │   └── 過去成功コンテンツの類似テーマ展開
   ├── トレンドベース企画（30%）
   │   └── 最新トレンドに基づく新規テーマ
   └── 重複チェック・フィルタリング

4. スケジュール最適化
   ├── 過去データから最適投稿時間を算出
   ├── カテゴリのバランス調整
   └── 30日分のカレンダー配置
```

**出力形式:**
```typescript
interface PlannedPost {
  id: string;                        // UUID
  userId: string;                    // ユーザーID
  title: string;                     // タイトル（30文字以内）
  hook: string;                      // 冒頭のフック文（15文字以内）
  category: string;                  // カテゴリ
  targetPainPoint: string;           // 解決する課題
  keyTakeaway: string;               // 主要なポイント
  estimatedEngagement: number;       // 予測エンゲージメント率
  dataSource: "winning_pattern" | "trend";
  scheduledAt: Date;                 // 予定投稿日時
  status: "planned";
  createdAt: Date;
  metadata: {
    trendKeywords?: string[];        // 関連トレンドキーワード
    referencePostId?: string;        // 参考にした過去投稿
    aiConfidenceScore: number;       // AI確信度 (0-1)
  };
}
```

#### 3.1.2. インタラクティブ・カレンダーUI

**機能一覧:**

| 機能 | 説明 | 優先度 |
|:---|:---|:---|
| カレンダー表示 | 月間/週間/日次ビューの切り替え | 必須 |
| ステータス表示 | 企画済/生成中/レビュー待ち/承認済/投稿済をカラー表示 | 必須 |
| ドラッグ&ドロップ | 投稿日の変更 | 必須 |
| クイックプレビュー | ホバーで概要表示 | 必須 |
| 一括操作 | 複数選択して削除/ステータス変更 | 推奨 |
| フィルター | ステータス/カテゴリでの絞り込み | 推奨 |
| エクスポート | CSV/iCal形式での出力 | 任意 |

**ステータス遷移:**
```
[planned] → [generating] → [review] → [approved] → [scheduled] → [published]
     │            │            │            │
     └──[deleted] └──[failed]  └──[rejected]
```

**UIコンポーネント仕様:**
```typescript
interface CalendarPost {
  id: string;
  date: Date;
  title: string;
  status: PostStatus;
  category: string;
  thumbnailUrl?: string;
  engagementPrediction?: number;
}

type PostStatus =
  | "planned"      // 企画済み（青）
  | "generating"   // 生成中（黄）
  | "review"       // レビュー待ち（オレンジ）
  | "approved"     // 承認済み（緑）
  | "scheduled"    // 予約済み（紫）
  | "published"    // 投稿済み（グレー）
  | "failed"       // 失敗（赤）
  | "rejected";    // 却下（赤点線）
```

### 3.2. 制作フェーズ (The "Factory")

#### 3.2.1. Just-in-Time 生成エンジン

**トリガー条件:**
- 投稿予定日の2日前 00:00 JST（自動）
- ユーザーによる「今すぐ生成」ボタン押下

**処理パイプライン:**

```
Phase 1: Deep Research（約60秒）
├── 1.1. 企画情報の取得
├── 1.2. Gemini Grounding検索（3-5クエリ）
├── 1.3. 検索結果の構造化
└── 1.4. 台本JSON生成

Phase 2: Asset Generation（約90秒）
├── 2.1. 背景画像生成 (DALL-E 3) × 5-6枚
├── 2.2. 画像ダウンロード・保存
├── 2.3. テキストオーバーレイ生成 (Pillow)
└── 2.4. 音声生成 (ElevenLabs)

Phase 3: Video Composition（約90秒）
├── 3.1. スライドシーケンス作成
├── 3.2. 音声同期
├── 3.3. BGM・SE追加
├── 3.4. エフェクト適用（ズーム、トランジション）
└── 3.5. MP4エンコード（H.264, 1080x1920）

Phase 4: Finalization（約30秒）
├── 4.1. 品質チェック（解像度、音量、長さ）
├── 4.2. サムネイル生成
├── 4.3. Supabase Storageへアップロード
└── 4.4. ステータス更新・通知送信
```

**台本JSONスキーマ:**
```typescript
interface VideoScript {
  postId: string;
  title: string;
  totalDuration: number;              // 秒（最大60）

  slides: Slide[];

  audio: {
    narrationText: string;            // 全体の読み上げテキスト
    voiceId: string;                  // ElevenLabs Voice ID
    speed: number;                    // 読み上げ速度 (0.8-1.2)
  };

  music: {
    trackId: string;                  // BGMトラックID
    volume: number;                   // 音量 (0-1)
  };

  caption: {
    text: string;                     // 投稿キャプション
    hashtags: string[];               // ハッシュタグ（最大30個）
  };
}

interface Slide {
  order: number;                      // 表示順
  duration: number;                   // 表示時間（秒）

  background: {
    prompt: string;                   // DALL-E用プロンプト
    style: "illustration" | "photo" | "abstract";
    colorScheme: string;              // 例: "warm", "cool", "brand"
  };

  textElements: TextElement[];

  animation: {
    type: "zoom_in" | "zoom_out" | "pan" | "none";
    intensity: number;                // 1-10
  };

  narrationSegment: string;           // このスライド用の読み上げテキスト
}

interface TextElement {
  content: string;
  position: {
    x: number;                        // 0-100 (%)
    y: number;                        // 0-100 (%)
    anchor: "top-left" | "center" | "bottom-right";
  };
  style: {
    fontSize: number;                 // ピクセル
    fontFamily: string;
    fontWeight: "normal" | "bold";
    color: string;                    // HEX
    backgroundColor?: string;
    borderRadius?: number;
    padding?: number;
    shadow?: boolean;
  };
  animation?: {
    type: "fade_in" | "slide_up" | "pop";
    delay: number;                    // 秒
  };
}
```

#### 3.2.2. 画像生成仕様

**DALL-E 3プロンプトテンプレート:**
```
Create a [style] background image for a business educational video.
Theme: [theme]
Requirements:
- No text or letters in the image
- Leave clear space in the center for text overlay
- Aspect ratio: 9:16 (vertical/portrait)
- Color scheme: [colorScheme]
- Style: Modern, clean, professional
- Do NOT include any people's faces
```

**Pillow テキスト合成仕様:**
```python
# フォント設定
FONT_CONFIG = {
    "title": {
        "family": "NotoSansJP-Bold",
        "size": 72,
        "color": "#FFFFFF",
        "stroke_width": 3,
        "stroke_color": "#000000"
    },
    "body": {
        "family": "NotoSansJP-Medium",
        "size": 48,
        "color": "#FFFFFF",
        "stroke_width": 2,
        "stroke_color": "#333333"
    },
    "emphasis": {
        "family": "NotoSansJP-Black",
        "size": 64,
        "color": "#FFD700",
        "stroke_width": 4,
        "stroke_color": "#000000"
    }
}

# 視認性確保
MIN_CONTRAST_RATIO = 4.5  # WCAG AA準拠
AUTO_BACKGROUND_BLUR = True
```

#### 3.2.3. 動画合成仕様

**FFmpeg設定:**
```bash
# 出力仕様
Resolution: 1080x1920 (9:16)
Codec: H.264 (libx264)
Bitrate: 8Mbps (video), 192kbps (audio)
FPS: 30
Duration: 15-60 seconds
Format: MP4

# エフェクト
Zoom: 1.0 → 1.1 over slide duration (Ken Burns effect)
Transition: 0.3s crossfade between slides
Audio: -14 LUFS (normalized)
```

### 3.3. 運用・改善フェーズ (The "Manager")

#### 3.3.1. アナリティクス・フィードバック

**データ収集スケジュール:**
| タイミング | 取得データ | 用途 |
|:---|:---|:---|
| 投稿直後 | 投稿ID、URL | 記録 |
| 24時間後 | 初期再生数、リーチ | 初動分析 |
| 72時間後 | 再生数、いいね、保存、コメント | 中間分析 |
| 7日後 | 最終パフォーマンス | 評価確定 |
| 30日後 | 長期トレンド | パターン分析 |

**インサイト分析項目:**
```typescript
interface PostAnalytics {
  postId: string;
  instagramMediaId: string;

  // 基本指標
  metrics: {
    impressions: number;
    reach: number;
    plays: number;
    likes: number;
    comments: number;
    saves: number;
    shares: number;
  };

  // 計算指標
  calculated: {
    engagementRate: number;           // (likes + comments + saves) / reach
    saveRate: number;                 // saves / reach
    completionRate: number;           // 完視聴率（利用可能な場合）
  };

  // 比較指標
  comparison: {
    vsAverage: number;                // 自アカウント平均との比較
    vsCategoryAverage: number;        // 同カテゴリ平均との比較
    rank: number;                     // 過去90日での順位
  };

  collectedAt: Date;
}
```

#### 3.3.2. オート・パブリッシャー

**投稿フロー:**
```
1. 予約時刻の15分前
   └── 最終チェック（動画ファイル存在確認）

2. 予約時刻
   ├── Meta API呼び出し
   │   ├── メディアコンテナ作成
   │   ├── 動画アップロード
   │   └── 公開実行
   ├── 成功時
   │   ├── ステータス更新 → "published"
   │   └── Instagram Media ID保存
   └── 失敗時
       ├── リトライ（最大3回、5分間隔）
       └── 失敗通知送信

3. 投稿後
   └── 24時間後のアナリティクス取得をスケジュール
```

**Meta Graph API エンドポイント:**
```
# Reels投稿
POST /v18.0/{ig-user-id}/media
  - media_type: REELS
  - video_url: {supabase_storage_url}
  - caption: {generated_caption}
  - share_to_feed: true

POST /v18.0/{ig-user-id}/media_publish
  - creation_id: {media_container_id}

# インサイト取得
GET /v18.0/{media-id}/insights
  - metric: plays,reach,saved,likes,comments,shares
```

---

## 4. 非機能要件

### 4.1. パフォーマンス要件

| 項目 | 要件 | 測定方法 |
|:---|:---|:---|
| ページ読み込み時間 | 初回: 3秒以内、遷移: 1秒以内 | Lighthouse |
| 動画生成時間 | 5分以内/本 | Cloud Run ログ |
| API応答時間 | 95%ile 500ms以内 | Vercel Analytics |
| 同時生成数 | 10本/ユーザー | Cloud Run並列実行 |

### 4.2. 可用性要件

| 項目 | 要件 |
|:---|:---|
| サービス稼働率 | 99.5%以上（月間ダウンタイム: 3.6時間以内） |
| 計画メンテナンス | 月1回、深夜2-4時（事前告知必須） |
| データバックアップ | 日次自動バックアップ、7日間保持 |
| 障害復旧目標 (RTO) | 4時間以内 |
| 復旧時点目標 (RPO) | 24時間以内 |

### 4.3. セキュリティ要件

#### 4.3.1. 認証・認可
```
- Supabase Auth による認証
  - メール/パスワード認証
  - OAuth (Google, Apple) - Phase 2以降
  - 2要素認証 - SaaS化時に必須

- Row Level Security (RLS)
  - 全テーブルにRLSポリシー適用
  - ユーザーは自身のデータのみアクセス可能

- API認証
  - JWT Bearer Token
  - トークン有効期限: 1時間
  - リフレッシュトークン: 7日
```

#### 4.3.2. データ保護
```
- 通信: TLS 1.3必須
- 保存: AES-256暗号化（Supabase標準）
- APIキー: 環境変数管理、コードにハードコード禁止
- ログ: 個人情報マスキング
```

#### 4.3.3. 入力検証
```typescript
// サーバーサイドバリデーション（Zod）
const postSchema = z.object({
  title: z.string().min(1).max(100),
  scheduledAt: z.date().min(new Date()),
  category: z.enum(["marketing", "finance", "management", "technology"]),
});

// SQLインジェクション対策: Supabase Client使用（パラメータ化クエリ）
// XSS対策: React自動エスケープ + DOMPurify
```

### 4.4. スケーラビリティ要件

| フェーズ | 想定ユーザー数 | 想定投稿数/月 | インフラ構成 |
|:---|:---|:---|:---|
| MVP | 1（自己利用） | 30本 | 最小構成 |
| α版 | 10 | 300本 | Supabase Pro |
| β版 | 100 | 3,000本 | Cloud Run スケールアップ |
| 正式版 | 1,000+ | 30,000本+ | マルチリージョン検討 |

---

## 5. データベース設計

### 5.1. ER図

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│   profiles  │       │    posts    │       │   assets    │
├─────────────┤       ├─────────────┤       ├─────────────┤
│ id (PK)     │──┐    │ id (PK)     │──┐    │ id (PK)     │
│ email       │  │    │ user_id(FK) │  │    │ post_id(FK) │
│ full_name   │  └───<│ title       │  └───<│ type        │
│ avatar_url  │       │ script_json │       │ url         │
│ ig_account  │       │ status      │       │ metadata    │
│ preferences │       │ scheduled_at│       │ created_at  │
│ created_at  │       │ published_at│       └─────────────┘
│ updated_at  │       │ ig_media_id │
└─────────────┘       │ created_at  │       ┌─────────────┐
                      │ updated_at  │       │  analytics  │
                      └─────────────┘       ├─────────────┤
                                            │ id (PK)     │
                                       ┌───>│ post_id(FK) │
                                       │    │ impressions │
                                       │    │ reach       │
                                       │    │ plays       │
                                       │    │ likes       │
                                       │    │ saves       │
                                       │    │ collected_at│
                                       │    └─────────────┘
                                       │
                      ┌────────────────┘
```

### 5.2. テーブル定義

#### profiles
```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  avatar_url TEXT,

  -- Instagram連携
  ig_user_id TEXT,
  ig_access_token TEXT,  -- 暗号化保存
  ig_token_expires_at TIMESTAMPTZ,

  -- ユーザー設定
  preferences JSONB DEFAULT '{
    "targetAudience": "",
    "mainThemes": [],
    "toneOfVoice": "friendly",
    "defaultPostTime": "18:00",
    "timezone": "Asia/Tokyo"
  }'::jsonb,

  -- サブスクリプション（SaaS化時）
  subscription_tier TEXT DEFAULT 'free',
  subscription_expires_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLSポリシー
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own profile" ON profiles
  FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own profile" ON profiles
  FOR UPDATE USING (auth.uid() = id);
```

#### posts
```sql
CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,

  -- コンテンツ情報
  title TEXT NOT NULL,
  hook TEXT,
  category TEXT,
  target_pain_point TEXT,
  key_takeaway TEXT,

  -- 生成データ
  script_json JSONB,
  caption TEXT,
  hashtags TEXT[],

  -- ステータス管理
  status TEXT NOT NULL DEFAULT 'planned'
    CHECK (status IN ('planned', 'generating', 'review', 'approved',
                      'scheduled', 'published', 'failed', 'rejected', 'deleted')),

  -- スケジュール
  scheduled_at TIMESTAMPTZ,
  published_at TIMESTAMPTZ,

  -- Instagram連携
  ig_media_id TEXT,
  ig_permalink TEXT,

  -- メタデータ
  metadata JSONB DEFAULT '{}'::jsonb,
  generation_started_at TIMESTAMPTZ,
  generation_completed_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_posts_user_status ON posts(user_id, status);
CREATE INDEX idx_posts_scheduled ON posts(scheduled_at) WHERE status = 'approved';
CREATE INDEX idx_posts_user_date ON posts(user_id, scheduled_at);

-- RLSポリシー
ALTER TABLE posts ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can manage own posts" ON posts
  FOR ALL USING (auth.uid() = user_id);
```

#### assets
```sql
CREATE TABLE assets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,

  type TEXT NOT NULL
    CHECK (type IN ('background_image', 'composed_image', 'audio', 'video', 'thumbnail')),

  url TEXT NOT NULL,
  storage_path TEXT NOT NULL,

  -- メタデータ
  metadata JSONB DEFAULT '{}'::jsonb,
  -- 例: {"width": 1080, "height": 1920, "duration": 5.2, "size_bytes": 1234567}

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_assets_post ON assets(post_id);
```

#### analytics
```sql
CREATE TABLE analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,

  -- 基本指標
  impressions INTEGER DEFAULT 0,
  reach INTEGER DEFAULT 0,
  plays INTEGER DEFAULT 0,
  likes INTEGER DEFAULT 0,
  comments INTEGER DEFAULT 0,
  saves INTEGER DEFAULT 0,
  shares INTEGER DEFAULT 0,

  -- 計算指標
  engagement_rate DECIMAL(5,4),
  save_rate DECIMAL(5,4),

  collected_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_analytics_post ON analytics(post_id);
CREATE INDEX idx_analytics_collected ON analytics(collected_at);
```

#### generation_queue（ジョブキュー）
```sql
CREATE TABLE generation_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,

  priority INTEGER DEFAULT 0,  -- 高いほど優先
  status TEXT NOT NULL DEFAULT 'pending'
    CHECK (status IN ('pending', 'processing', 'completed', 'failed')),

  attempts INTEGER DEFAULT 0,
  max_attempts INTEGER DEFAULT 3,
  last_error TEXT,

  scheduled_for TIMESTAMPTZ NOT NULL,
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_queue_status ON generation_queue(status, scheduled_for);
```

---

## 6. API設計

### 6.1. REST API エンドポイント一覧

#### 認証
| Method | Endpoint | 説明 |
|:---|:---|:---|
| POST | /api/auth/signup | 新規登録 |
| POST | /api/auth/login | ログイン |
| POST | /api/auth/logout | ログアウト |
| POST | /api/auth/refresh | トークンリフレッシュ |
| GET | /api/auth/instagram/connect | Instagram OAuth開始 |
| GET | /api/auth/instagram/callback | Instagram OAuth コールバック |

#### Posts（投稿管理）
| Method | Endpoint | 説明 |
|:---|:---|:---|
| GET | /api/posts | 投稿一覧取得 |
| POST | /api/posts | 投稿作成（手動） |
| GET | /api/posts/:id | 投稿詳細取得 |
| PATCH | /api/posts/:id | 投稿更新 |
| DELETE | /api/posts/:id | 投稿削除 |
| POST | /api/posts/:id/generate | 動画生成開始 |
| POST | /api/posts/:id/approve | 投稿承認 |
| POST | /api/posts/:id/reject | 投稿却下 |

#### Planning（企画）
| Method | Endpoint | 説明 |
|:---|:---|:---|
| POST | /api/planning/generate | 月次企画一括生成 |
| POST | /api/planning/single | 単発企画生成 |
| GET | /api/planning/trends | トレンド情報取得 |

#### Analytics（分析）
| Method | Endpoint | 説明 |
|:---|:---|:---|
| GET | /api/analytics/overview | 全体サマリー |
| GET | /api/analytics/posts/:id | 個別投稿分析 |
| GET | /api/analytics/trends | パフォーマンストレンド |

#### Settings（設定）
| Method | Endpoint | 説明 |
|:---|:---|:---|
| GET | /api/settings/profile | プロフィール取得 |
| PATCH | /api/settings/profile | プロフィール更新 |
| GET | /api/settings/preferences | 設定取得 |
| PATCH | /api/settings/preferences | 設定更新 |

### 6.2. API レスポンス形式

**成功時:**
```json
{
  "success": true,
  "data": { ... },
  "meta": {
    "total": 100,
    "page": 1,
    "limit": 20
  }
}
```

**エラー時:**
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "タイトルは必須です",
    "details": [
      { "field": "title", "message": "必須項目です" }
    ]
  }
}
```

### 6.3. エラーコード一覧

| コード | HTTPステータス | 説明 |
|:---|:---|:---|
| UNAUTHORIZED | 401 | 認証が必要 |
| FORBIDDEN | 403 | アクセス権限なし |
| NOT_FOUND | 404 | リソースが存在しない |
| VALIDATION_ERROR | 400 | 入力値が不正 |
| RATE_LIMIT_EXCEEDED | 429 | レート制限超過 |
| GENERATION_FAILED | 500 | 動画生成失敗 |
| EXTERNAL_API_ERROR | 502 | 外部API呼び出し失敗 |
| SERVICE_UNAVAILABLE | 503 | サービス一時停止中 |

---

## 7. 外部サービス連携仕様

### 7.1. Gemini API

**用途:** 企画立案、台本生成、キャプション生成

**使用モデル:** `gemini-1.5-pro-latest`

**主要パラメータ:**
```typescript
const geminiConfig = {
  temperature: 0.7,          // 創造性（企画時は0.8、台本時は0.5）
  topP: 0.9,
  topK: 40,
  maxOutputTokens: 8192,
  safetySettings: [
    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
  ]
};
```

**Grounding（検索連携）設定:**
```typescript
const groundingConfig = {
  googleSearchRetrieval: {
    dynamicRetrievalConfig: {
      mode: "MODE_DYNAMIC",
      dynamicThreshold: 0.3
    }
  }
};
```

**コスト見積もり:**
- 入力: $0.00125 / 1K tokens
- 出力: $0.005 / 1K tokens
- 月間想定: 30投稿 × 約5,000 tokens = 150,000 tokens ≈ $1.00

### 7.2. OpenAI API (DALL-E 3)

**用途:** 背景画像生成

**パラメータ:**
```typescript
const dalleConfig = {
  model: "dall-e-3",
  size: "1024x1792",         // 縦長（9:16近似）
  quality: "standard",        // "hd"は高コスト
  style: "vivid",            // または "natural"
  n: 1                       // 1枚ずつ生成
};
```

**コスト見積もり:**
- Standard 1024x1792: $0.080 / 画像
- 月間想定: 30投稿 × 6枚 = 180枚 ≈ $14.40

### 7.3. ElevenLabs API

**用途:** ナレーション音声生成

**推奨Voice ID:** 日本語対応ボイス（要事前選定）

**パラメータ:**
```typescript
const elevenLabsConfig = {
  model_id: "eleven_multilingual_v2",
  voice_settings: {
    stability: 0.5,
    similarity_boost: 0.75,
    style: 0.0,
    use_speaker_boost: true
  }
};
```

**コスト見積もり:**
- Starter Plan: $5/月（30,000文字）
- 月間想定: 30投稿 × 500文字 = 15,000文字 → Starter Plan内

### 7.4. Meta Graph API

**必要な権限:**
```
- instagram_basic
- instagram_content_publish
- instagram_manage_insights
- pages_read_engagement
```

**レート制限:**
- 投稿: 25投稿/日
- インサイト取得: 200リクエスト/時

**トークン管理:**
```
- 短期トークン: 1時間（OAuth直後）
- 長期トークン: 60日（交換後）
- 自動リフレッシュ: 有効期限7日前
```

---

## 8. エラーハンドリング

### 8.1. エラー分類と対応方針

| 分類 | 例 | 対応 |
|:---|:---|:---|
| 一時的エラー | API タイムアウト、レート制限 | 自動リトライ（exponential backoff） |
| 入力エラー | バリデーション失敗 | ユーザーに修正を促す |
| システムエラー | DB接続失敗 | アラート発報、手動対応 |
| 外部依存エラー | DALL-E サービス停止 | フォールバック or 保留 |

### 8.2. リトライ戦略

```typescript
const retryConfig = {
  maxAttempts: 3,
  initialDelayMs: 1000,
  maxDelayMs: 30000,
  backoffMultiplier: 2,
  retryableErrors: [
    "ETIMEDOUT",
    "ECONNRESET",
    "RATE_LIMIT_EXCEEDED",
    "SERVICE_UNAVAILABLE"
  ]
};
```

### 8.3. フォールバック戦略

| サービス | フォールバック |
|:---|:---|
| DALL-E 3 | ストック画像ライブラリから選択 |
| ElevenLabs | Google Cloud TTS |
| Gemini | OpenAI GPT-4 Turbo |
| Supabase Storage | 一時的にCloud Storage |

### 8.4. 監視・アラート

**監視項目:**
- 動画生成成功率（閾値: 95%未満でアラート）
- API応答時間（閾値: p95 > 2秒でアラート）
- エラー率（閾値: 5%超過でアラート）
- 外部APIクォータ残量（閾値: 20%未満で警告）

**通知チャネル:**
- 重大: Slack + SMS
- 警告: Slack
- 情報: ダッシュボード表示のみ

---

## 9. テスト戦略

### 9.1. テストピラミッド

```
        /\
       /  \      E2E Tests (10%)
      /────\     - ユーザーフロー全体
     /      \    - Playwright
    /────────\
   /          \  Integration Tests (20%)
  /────────────\ - API統合テスト
 /              \- Supabase連携
/────────────────\
        |         Unit Tests (70%)
        |         - ビジネスロジック
        |         - Vitest
```

### 9.2. テストカバレッジ目標

| 対象 | カバレッジ目標 |
|:---|:---|
| ビジネスロジック | 90%以上 |
| APIルート | 80%以上 |
| UIコンポーネント | 70%以上 |
| 全体 | 80%以上 |

### 9.3. テスト環境

```
- 単体テスト: Vitest + Testing Library
- E2Eテスト: Playwright
- APIテスト: Supertest
- モック: MSW (Mock Service Worker)
- CI: GitHub Actions
```

### 9.4. テストデータ

```typescript
// テスト用シードデータ
const testUser = {
  email: "test@example.com",
  preferences: { targetAudience: "テスト用ターゲット" }
};

const testPost = {
  title: "テスト投稿",
  status: "planned",
  scheduledAt: new Date("2025-01-15T18:00:00+09:00")
};
```

---

## 10. デプロイメント

### 10.1. CI/CDパイプライン

```yaml
# GitHub Actions ワークフロー
name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check
      - run: npm run test:unit
      - run: npm run test:e2e

  deploy-preview:
    if: github.event_name == 'pull_request'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}

  deploy-production:
    if: github.ref == 'refs/heads/main'
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: '--prod'
```

### 10.2. 環境変数管理

```bash
# .env.local（ローカル開発用）
# .env.production（本番用 - Vercel管理）

# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# AI APIs
GOOGLE_AI_API_KEY=
OPENAI_API_KEY=
ELEVENLABS_API_KEY=

# Meta
META_APP_ID=
META_APP_SECRET=

# Cloud Run
GOOGLE_CLOUD_PROJECT=
GOOGLE_APPLICATION_CREDENTIALS=
```

### 10.3. ブルーグリーンデプロイ

```
本番デプロイ時:
1. 新バージョンをステージング環境にデプロイ
2. ヘルスチェック・スモークテスト実行
3. トラフィックを段階的に切り替え（10% → 50% → 100%）
4. 問題発生時は即座にロールバック
```

---

## 11. コスト管理

### 11.1. 月間コスト見積もり（1ユーザー/30投稿）

| サービス | 内訳 | 月額 |
|:---|:---|:---|
| Vercel | Hobby Plan | $0 |
| Supabase | Free Tier | $0 |
| Google Cloud Run | ~10時間/月 | ~$5 |
| Gemini API | 150K tokens | ~$1 |
| DALL-E 3 | 180枚 | ~$15 |
| ElevenLabs | 15K文字 | $5 |
| **合計** | | **~$26** |

※ SaaS化時は規模に応じてボリュームディスカウント適用

### 11.2. コスト最適化施策

1. **Just-in-Time生成**: 使わない企画の画像生成を回避
2. **キャッシュ活用**: 類似プロンプトの画像再利用
3. **バッチ処理**: Cloud Run Jobsで秒単位課金
4. **リージョン最適化**: 東京リージョンでレイテンシ削減

---

## 12. 開発ロードマップ

### Phase 1: MVP (Core Engine)
**期間:** 2週間
**目標:** ローカル環境で1本の高品質動画が自動生成される

| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| 環境構築 | Python環境、FFmpeg、フォント設定 | スクリプト実行可能 |
| 台本生成 | Gemini API連携、JSONスキーマ定義 | 有効な台本JSON出力 |
| 画像生成 | DALL-E 3連携、プロンプト最適化 | 5-6枚の背景画像生成 |
| 文字合成 | Pillow実装、フォント設定 | 読みやすいテキスト合成 |
| 動画結合 | FFmpeg実装、エフェクト追加 | 60秒以内のMP4出力 |
| 品質検証 | 実機確認、フィードバック反映 | Instagram投稿可能な品質 |

### Phase 2: Platform Integration
**期間:** 2週間
**目標:** ブラウザから操作可能なWebアプリケーション

| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Next.js構築 | プロジェクト設定、認証実装 | ログイン/ログアウト動作 |
| Supabase連携 | DB設計、RLS設定 | CRUD操作成功 |
| カレンダーUI | 月間表示、ステータス管理 | ドラッグ&ドロップ動作 |
| Cloud Run移行 | Docker化、デプロイ設定 | リモート生成成功 |
| プレビュー機能 | 動画プレビュー、編集UI | 生成結果の確認可能 |

### Phase 3: Automation & Analytics
**期間:** 継続的
**目標:** 完全自動運用とSaaS化準備

| タスク | 詳細 | 完了条件 |
|:---|:---|:---|
| Meta API連携 | OAuth実装、投稿自動化 | 自動投稿成功 |
| インサイト取得 | 定期バッチ、データ蓄積 | 分析データ表示 |
| AI編集会議 | 企画自動生成、トレンド反映 | 30日分の企画生成 |
| 通知機能 | レビュー依頼、投稿完了通知 | 通知受信確認 |
| マルチテナント | 課金連携、プラン管理 | 複数ユーザー運用 |

---

## 13. リスク管理

### 13.1. 技術リスク

| リスク | 影響度 | 発生確率 | 対策 |
|:---|:---|:---|:---|
| API料金高騰 | 高 | 中 | 使用量モニタリング、上限設定 |
| 外部APIサービス停止 | 高 | 低 | フォールバック実装 |
| 生成品質の不安定 | 中 | 中 | プロンプト最適化、人的チェック |
| Instagramポリシー変更 | 高 | 中 | 規約定期確認、代替プラン準備 |

### 13.2. ビジネスリスク

| リスク | 影響度 | 発生確率 | 対策 |
|:---|:---|:---|:---|
| 競合サービス出現 | 中 | 高 | 差別化機能の強化 |
| ユーザー獲得困難 | 高 | 中 | マーケティング戦略策定 |
| 法規制強化 | 中 | 低 | 法務チェック体制構築 |

---

## 14. 用語集

| 用語 | 説明 |
|:---|:---|
| Deep Research | Gemini Grounding機能を用いた深い情報収集 |
| Just-in-Time生成 | 投稿直前に動画を生成する方式 |
| AI編集会議 | AIによる月次コンテンツ企画プロセス |
| Ken Burns効果 | ゆっくりズームするビデオエフェクト |
| RLS | Row Level Security（行レベルセキュリティ） |
| Grounding | LLMの回答に検索結果を組み込む機能 |

---

## 15. 参考資料

- [Next.js Documentation](https://nextjs.org/docs)
- [Supabase Documentation](https://supabase.com/docs)
- [Gemini API Reference](https://ai.google.dev/docs)
- [OpenAI API Reference](https://platform.openai.com/docs)
- [Meta Graph API - Instagram](https://developers.facebook.com/docs/instagram-api)
- [ElevenLabs API Documentation](https://elevenlabs.io/docs)
- [FFmpeg Documentation](https://ffmpeg.org/documentation.html)

---

**文書管理情報**
- 作成者: Claude Code
- 最終更新: 2025-12-13
- ステータス: ドラフト
- 次回レビュー予定: Phase 1完了時
